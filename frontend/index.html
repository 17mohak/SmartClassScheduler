<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos | AI-Powered Academic Scheduling</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    animation: { 'blob': 'blob 7s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; overflow: hidden; /* Prevent double scrollbars */ }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }

        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .glass-card:hover { transform: translateY(-5px); border-color: rgba(99, 102, 241, 0.5); box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.3); }

        .text-gradient { background: linear-gradient(to right, #818cf8, #c084fc, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-link.active::after { content: ''; display: block; width: 100%; height: 2px; background: #818cf8; margin-top: 4px; }

        .custom-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(99, 102, 241, 0.2); color: white; transition: all 0.3s; width: 100%; padding: 8px; border-radius: 8px; }
        .custom-input:focus { border-color: #818cf8; outline: none; box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2); }

        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .page-transition { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; transform: translateY(100%); pointer-events: none; }

        /* Table Row Hover */
        tr.hover-row:hover td { background-color: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="antialiased h-screen flex flex-col relative">

    <div id="add-modal" class="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center hidden">
        <div class="glass p-8 rounded-2xl w-full max-w-sm border border-white/10 shadow-2xl relative">
            <button onclick="app.closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-indigo-600 rounded-xl mx-auto flex items-center justify-center text-xl font-bold mb-2 shadow-lg"><i class="fas fa-plus"></i></div>
                <h3 class="text-2xl font-bold" id="modal-title">Add New</h3>
            </div>
            <form onsubmit="app.submitAdd(event)" class="space-y-4" id="add-form"></form>
        </div>
    </div>

    <div id="login-overlay" class="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center hidden">
        <div class="glass p-8 rounded-2xl w-full max-w-md space-y-6 relative overflow-hidden border border-white/10 shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl mx-auto flex items-center justify-center text-3xl font-bold mb-4 shadow-lg shadow-indigo-500/30">C</div>
                <h2 class="text-3xl font-bold">Welcome Back</h2>
                <p class="text-slate-400">Sign in to manage schedules</p>
            </div>
            <form onsubmit="auth.login(event)" class="space-y-4">
                <div>
                    <label class="text-xs uppercase font-bold text-slate-500 tracking-wider">Username</label>
                    <input type="text" id="login-user" class="custom-input mt-1" placeholder="admin" required>
                </div>
                <div>
                    <label class="text-xs uppercase font-bold text-slate-500 tracking-wider">Password</label>
                    <input type="password" id="login-pass" class="custom-input mt-1" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold transition-all shadow-lg hover:shadow-indigo-500/50">Sign In</button>
            </form>
            <button onclick="auth.closeLogin()" class="w-full text-sm text-slate-500 hover:text-white">Cancel</button>
        </div>
    </div>

    <div class="page-transition" id="pageTransition"></div>

    <nav class="fixed top-0 left-0 w-full h-20 glass border-b border-white/10 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex items-center justify-between h-full">
                <div class="flex items-center gap-3 cursor-pointer" onclick="router.navigate('home')">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-indigo-500/30">C</div>
                    <span class="font-bold text-2xl tracking-tight">Chronos</span>
                </div>

                <div class="hidden md:flex items-center space-x-8">
                    <button onclick="router.navigate('home')" id="nav-home" class="nav-link active text-sm font-medium hover:text-indigo-400 transition-colors">Product</button>
                    <button onclick="router.navigate('dashboard')" id="nav-dashboard" class="nav-link text-sm font-medium hover:text-indigo-400 transition-colors">Dashboard</button>

                    <div id="nav-auth-container">
                        <button onclick="auth.openLogin()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-full text-sm font-medium transition-all shadow-lg shadow-indigo-600/30 hover:shadow-indigo-600/50 hover:scale-105">
                            Login
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main id="app" class="pt-20 w-full h-screen relative flex flex-col overflow-hidden"></main>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';

        // --- TIME SLOTS CONFIGURATION ---
        const TIME_SLOTS = [
            { id: 0, label: "07:30 - 08:30" },
            { id: 1, label: "08:30 - 09:30" },
            { id: 2, label: "10:00 - 11:00" }, // Break visually handled in renderer
            { id: 3, label: "11:00 - 12:00" },
            { id: 4, label: "12:00 - 01:00" },
            { id: 5, label: "01:00 - 02:00" },
            { id: 6, label: "02:00 - 03:00" },
            { id: 7, label: "03:00 - 04:00" }
        ];

        // --- AUTH SYSTEM ---
        const auth = {
            token: null,
            user: null,

            openLogin: () => {
                document.getElementById('login-overlay').classList.remove('hidden');
                gsap.from("#login-overlay > div", { y: 50, opacity: 0, duration: 0.3 });
            },

            closeLogin: () => {
                document.getElementById('login-overlay').classList.add('hidden');
            },

            login: async (e) => {
                e.preventDefault();
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;

                try {
                    const res = await fetch(`${API_URL}/login/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: u, password: p})
                    });

                    if(!res.ok) throw new Error("Invalid Credentials");
                    const data = await res.json();

                    auth.token = data.token;
                    auth.user = data;

                    auth.closeLogin();
                    auth.updateNav();
                    router.navigate('dashboard');
                } catch(err) {
                    alert("Login Failed: " + err.message);
                }
            },

            logout: () => {
                auth.token = null;
                auth.user = null;
                auth.updateNav();
                router.navigate('home');
            },

            updateNav: () => {
                const container = document.getElementById('nav-auth-container');
                if (auth.user) {
                    const role = auth.user.is_admin ? "ADMIN" : "FACULTY";
                    container.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-mono text-indigo-300 bg-indigo-900/30 px-2 py-1 rounded border border-indigo-500/30">${role}</span>
                            <button onclick="auth.logout()" class="text-sm text-slate-400 hover:text-white">Logout</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <button onclick="auth.openLogin()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-full text-sm font-medium transition-all shadow-lg shadow-indigo-600/30 hover:shadow-indigo-600/50 hover:scale-105">
                            Login
                        </button>
                    `;
                }
            }
        };

        // --- ROUTER ---
        const router = {
            navigate: (pageId) => {
                // Auth Guard for Dashboard
                if (pageId === 'dashboard' && !auth.user) {
                    auth.openLogin();
                    return;
                }

                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                const activeNav = document.getElementById(`nav-${pageId}`);
                if(activeNav) activeNav.classList.add('active');

                const tl = gsap.timeline();
                tl.to("#pageTransition", { y: "0%", duration: 0.4, ease: "power2.inOut" })
                  .call(() => {
                      app.render(pageId);
                      // Only scroll window to top if it's the home page
                      if(pageId === 'home') window.scrollTo(0,0);
                  })
                  .to("#pageTransition", { y: "-100%", duration: 0.4, ease: "power2.inOut" });
            }
        };

        // --- VIEW CONTROLLER ---
        const app = {
            state: { subjects: [], teachers: [], batches: [], currentDept: null },
            activeTab: 'subjects',

            render: (pageId) => {
                const container = document.getElementById('app');

                if (pageId === 'home') {
                    // Home needs to scroll naturally
                    container.className = "pt-20 w-full h-full overflow-y-auto block";
                    container.innerHTML = views.home();
                    app.animateHome();
                } else if (pageId === 'dashboard') {
                    // Dashboard needs fixed layout (Split Screen)
                    container.className = "pt-20 w-full h-screen flex flex-col overflow-hidden";
                    container.innerHTML = views.dashboard();
                    app.initDashboard();
                }
            },

            // --- Home Page Logic ---
            animateHome: () => {
                gsap.from(".hero-content > *", { y: 50, opacity: 0, duration: 1, stagger: 0.1, ease: "power3.out" });
                gsap.from(".hero-visual", { x: 50, opacity: 0, duration: 1.2, delay: 0.3, ease: "power3.out" });
                gsap.to(".floating-card", { y: -15, duration: 2, repeat: -1, yoyo: true, stagger: { each: 0.5, from: "random" }, ease: "sine.inOut" });

                gsap.utils.toArray('.feature-card').forEach((card, i) => {
                    gsap.from(card, {
                        scrollTrigger: { trigger: card, start: "top 85%" },
                        y: 50, opacity: 0, duration: 0.8, delay: i * 0.1
                    });
                });
            },

            // --- Dashboard Logic ---
            initDashboard: async () => {
                // Render Empty Grid Immediately so table is visible
                app.renderTimetable([]);

                // Populate Faculty Preferences Dropdowns
                const opts = TIME_SLOTS.map(t => `<option value="${t.id}">${t.label}</option>`).join('');
                const s = document.getElementById('my-start'); if(s) s.innerHTML = opts;
                const e = document.getElementById('my-end'); if(e) e.innerHTML = opts;

                if (auth.user.is_admin) {
                    document.getElementById('admin-header').classList.remove('hidden');
                    document.getElementById('admin-actions').classList.remove('hidden');
                    // Load Departments into dropdown
                    const res = await fetch(`${API_URL}/departments/`, { headers: {'Authorization': `Token ${auth.token}`} });
                    const depts = await res.json();
                    const sel = document.getElementById('dept-select');
                    sel.innerHTML = '<option value="" disabled selected>Select Department</option>';
                    depts.forEach(d => sel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
                } else {
                    document.getElementById('faculty-header').classList.remove('hidden');
                    document.getElementById('faculty-prefs-panel').classList.remove('hidden');
                    // Lock Faculty to their dept
                    app.state.currentDept = auth.user.department_id;
                    app.refreshData();
                }
            },

            // Called when Admin selects a dept OR Faculty loads
            refreshData: async () => {
                const deptId = auth.user.is_admin ? document.getElementById('dept-select').value : auth.user.department_id;
                if(!deptId) return;
                app.state.currentDept = deptId;

                // Load Schedule Grid
                const sRes = await fetch(`${API_URL}/slots/`, { headers: {'Authorization': `Token ${auth.token}`} });
                const slots = await sRes.json();
                app.renderTimetable(slots);

                // If Admin, also load Data Manager
                if(auth.user.is_admin) {
                    const [bRes, tRes, subRes] = await Promise.all([
                        fetch(`${API_URL}/batches/`, { headers: {'Authorization': `Token ${auth.token}`} }),
                        fetch(`${API_URL}/teachers/`, { headers: {'Authorization': `Token ${auth.token}`} }),
                        fetch(`${API_URL}/subjects/`, { headers: {'Authorization': `Token ${auth.token}`} })
                    ]);

                    const [batches, teachers, subjects] = await Promise.all([bRes.json(), tRes.json(), subRes.json()]);

                    // Filter for current dept
                    app.state.batches = batches.filter(x => x.department == deptId);
                    app.state.teachers = teachers.filter(x => x.department == deptId);
                    app.state.subjects = subjects.filter(x => x.department == deptId);

                    app.renderDataManager();
                }
            },

            renderDataManager: () => {
                const container = document.getElementById('data-manager');
                container.innerHTML = '';

                // Toggle Buttons
                const btnSub = document.getElementById('btn-tab-sub');
                const btnTea = document.getElementById('btn-tab-tea');

                if (app.activeTab === 'subjects') {
                    btnSub.className = "flex-1 py-2 text-sm font-bold bg-indigo-600 text-white rounded shadow transition-all";
                    btnTea.className = "flex-1 py-2 text-sm font-bold bg-slate-800 hover:bg-slate-700 text-slate-400 rounded transition-all";

                    if(app.state.subjects.length === 0) return container.innerHTML = '<div class="text-center text-slate-500 mt-10">No subjects found.</div>';

                    app.state.subjects.forEach(sub => {
                        let bOpts = `<option value="">-- Batch --</option>`;
                        app.state.batches.forEach(b => bOpts += `<option value="${b.id}" ${sub.batch==b.id?'selected':''}>${b.name}</option>`);

                        let tOpts = `<option value="">-- Faculty --</option>`;
                        app.state.teachers.forEach(t => tOpts += `<option value="${t.id}" ${sub.teacher==t.id?'selected':''}>${t.name}</option>`);

                        container.innerHTML += `
                            <div class="glass p-3 rounded-lg border-l-4 border-indigo-500 mb-2 hover:bg-white/5 transition-colors">
                                <div class="flex justify-between mb-2">
                                    <span class="font-bold text-white">${sub.name}</span>
                                    <button onclick="app.deleteItem('subjects', ${sub.id})" class="text-slate-600 hover:text-red-400 transition-colors"><i class="fas fa-trash"></i></button>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <select class="custom-input text-xs py-1 sub-batch" data-id="${sub.id}">${bOpts}</select>
                                    <select class="custom-input text-xs py-1 sub-teacher" data-id="${sub.id}">${tOpts}</select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] uppercase text-slate-400 font-bold">Lecs/Wk:</span>
                                    <input type="number" min="1" value="${sub.weekly_lectures}" class="custom-input text-xs py-1 w-12 sub-lectures" data-id="${sub.id}">
                                </div>
                            </div>`;
                    });
                } else {
                    btnTea.className = "flex-1 py-2 text-sm font-bold bg-indigo-600 text-white rounded shadow transition-all";
                    btnSub.className = "flex-1 py-2 text-sm font-bold bg-slate-800 hover:bg-slate-700 text-slate-400 rounded transition-all";

                    if(app.state.teachers.length === 0) return container.innerHTML = '<div class="text-center text-slate-500 mt-10">No faculty found.</div>';

                    app.state.teachers.forEach(t => {
                        const timeOpts = TIME_SLOTS.map(ts => `<option value="${ts.id}" ${t.preferred_start_slot==ts.id?'selected':''}>${ts.label}</option>`).join('');
                        const endOpts = TIME_SLOTS.map(ts => `<option value="${ts.id}" ${t.preferred_end_slot==ts.id?'selected':''}>${ts.label}</option>`).join('');

                        container.innerHTML += `
                            <div class="glass p-3 rounded-lg border-l-4 border-pink-500 mb-2 hover:bg-white/5 transition-colors">
                                <div class="flex justify-between mb-2">
                                    <span class="font-bold text-white">${t.name}</span>
                                    <button onclick="app.deleteItem('teachers', ${t.id})" class="text-slate-600 hover:text-red-400 transition-colors"><i class="fas fa-trash"></i></button>
                                </div>
                                <div class="flex gap-2 items-center text-xs">
                                    <span class="text-slate-400 font-bold">Avail:</span>
                                    <select class="custom-input py-1 w-28 t-start" data-id="${t.id}">${timeOpts}</select>
                                    <span>-</span>
                                    <select class="custom-input py-1 w-28 t-end" data-id="${t.id}">${endOpts}</select>
                                </div>
                            </div>`;
                    });
                }
            },

            renderTimetable: (slots) => {
                const tbody = document.getElementById('timetable-body');
                tbody.innerHTML = '';
                const matrix = Array.from({ length: 8 }, () => Array(5).fill(null));
                const dayMap = { 'MON': 0, 'TUE': 1, 'WED': 2, 'THU': 3, 'FRI': 4 };

                // Maps for Names
                const tMap = {}; app.state.teachers.forEach(t => tMap[t.id] = t.name);
                const sMap = {}; app.state.subjects.forEach(s => sMap[s.id] = s.name);
                const bMap = {}; app.state.batches.forEach(b => bMap[b.id] = b.name);

                slots.forEach(slot => {
                    if (!auth.user.is_admin && slot.teacher != auth.user.teacher_id) return;

                    const timeKey = slot.start_time.substring(0, 5);
                    const slotIndex = TIME_SLOTS.findIndex(ts => ts.label.startsWith(timeKey));

                    if(slotIndex !== -1 && dayMap[slot.day] !== undefined) matrix[slotIndex][dayMap[slot.day]] = slot;
                });

                matrix.forEach((row, i) => {
                    // Inject Visual Break
                    if(i === 2) {
                        tbody.innerHTML += `
                            <tr class="bg-slate-800/30 border-y border-white/5">
                                <td class="p-2 text-center text-[10px] font-bold text-slate-500 tracking-[0.2em]" colspan="6">
                                    /// BREAK (09:30 - 10:00) ///
                                </td>
                            </tr>`;
                    }

                    let html = `<tr class="border-b border-white/5 h-24 hover-row transition-colors">
                        <td class="p-4 border-r border-white/5 font-mono text-slate-400 text-xs align-top pt-4">
                            ${TIME_SLOTS[i].label}
                        </td>`;

                    row.forEach(cell => {
                        html += `<td class="p-2 border-r border-white/5 w-1/5 relative">`;
                        if(cell) {
                            const colors = ['bg-indigo-600/20 border-indigo-500/30', 'bg-purple-600/20 border-purple-500/30', 'bg-emerald-600/20 border-emerald-500/30'];
                            const color = colors[cell.batch % colors.length] || colors[0];
                            const subName = auth.user.is_admin ? (sMap[cell.subject] || 'Subject') : (cell.subjectName || `Subject ${cell.subject}`);

                            html += `
                                <div class="${color} border rounded-lg p-3 h-full text-xs shadow-lg group hover:scale-[1.02] transition-all cursor-pointer absolute inset-1 flex flex-col justify-between">
                                    <div class="font-bold text-white line-clamp-2">${subName}</div>
                                    <div class="text-[10px] text-slate-300 flex justify-between items-end">
                                        <span><i class="fas fa-door-open mr-1"></i>${cell.room}</span>
                                        ${auth.user.is_admin ? `<span class="bg-black/30 px-1 rounded">${bMap[cell.batch]||'Batch'}</span>` : ''}
                                    </div>
                                </div>`;
                        }
                        html += `</td>`;
                    });
                    html += `</tr>`;
                    tbody.innerHTML += html;
                });
            },

            // --- CRUD ACTIONS ---
            openModal: () => {
                if(!app.state.currentDept) return alert("Select Dept First");
                document.getElementById('add-modal').classList.remove('hidden');
                const form = document.getElementById('add-form');
                const title = document.getElementById('modal-title');

                if(app.activeTab === 'teachers') {
                    title.textContent = "Add Faculty";
                    form.innerHTML = `
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Name</label><input name="name" class="custom-input mt-1" placeholder="Dr. Smith" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Email</label><input name="email" class="custom-input mt-1" placeholder="email@univ.edu"></div>
                        <div class="pt-4 border-t border-white/10"><label class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Login Username</label><input name="username" class="custom-input mt-1" required></div>
                        <div><label class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Login Password</label><input name="password" type="password" class="custom-input mt-1" required></div>
                        <button class="w-full bg-indigo-600 py-3 rounded-lg font-bold mt-4 hover:bg-indigo-500 shadow-lg transition-transform hover:scale-[1.02]">Create Account</button>`;
                } else {
                    title.textContent = "Add Subject";
                    form.innerHTML = `
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Name</label><input name="name" class="custom-input mt-1" placeholder="Physics" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Code</label><input name="code" class="custom-input mt-1" placeholder="PHY101"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Lectures/Week</label><input name="weekly_lectures" type="number" min="1" class="custom-input mt-1" value="3" required></div>
                        <button class="w-full bg-indigo-600 py-3 rounded-lg font-bold mt-4 hover:bg-indigo-500 shadow-lg transition-transform hover:scale-[1.02]">Add Subject</button>`;
                }
            },
            closeModal: () => document.getElementById('add-modal').classList.add('hidden'),

            submitAdd: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const payload = Object.fromEntries(formData.entries());
                payload.department = app.state.currentDept;
                try {
                    const ep = app.activeTab === 'teachers' ? 'teachers' : 'subjects';
                    const res = await fetch(`${API_URL}/${ep}/`, {
                        method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Token ${auth.token}`}, body: JSON.stringify(payload)
                    });
                    if(!res.ok) throw new Error("Failed");
                    app.closeModal(); app.refreshData();
                } catch(e) { alert("Error adding item"); }
            },

            deleteItem: async (type, id) => {
                if(!confirm("Delete?")) return;
                await fetch(`${API_URL}/${type}/${id}/`, { method: 'DELETE', headers: {'Authorization': `Token ${auth.token}`} });
                app.refreshData();
            },

            saveChanges: async () => {
                const btn = document.getElementById('saveBtn'); btn.textContent = "Saving...";
                const updates = [];
                document.querySelectorAll('.sub-batch').forEach(el => {
                    const id = el.dataset.id;
                    updates.push(fetch(`${API_URL}/subjects/${id}/`, {
                        method: 'PATCH', headers: {'Content-Type': 'application/json', 'Authorization': `Token ${auth.token}`},
                        body: JSON.stringify({
                            batch: el.value || null,
                            teacher: document.querySelector(`.sub-teacher[data-id="${id}"]`).value || null,
                            weekly_lectures: document.querySelector(`.sub-lectures[data-id="${id}"]`).value
                        })
                    }));
                });
                document.querySelectorAll('.t-start').forEach(el => {
                    const id = el.dataset.id;
                    updates.push(fetch(`${API_URL}/teachers/${id}/`, {
                        method: 'PATCH', headers: {'Content-Type': 'application/json', 'Authorization': `Token ${auth.token}`},
                        body: JSON.stringify({ preferred_start_slot: el.value, preferred_end_slot: document.querySelector(`.t-end[data-id="${id}"]`).value })
                    }));
                });
                await Promise.all(updates);
                app.refreshData();
                btn.textContent = "Save Changes";
            },

            runGeneration: async () => {
                if(!app.state.currentDept) return;
                const btn = document.getElementById('genBtn'); btn.textContent = "Generating...";
                await fetch(`${API_URL}/generate/`, {
                    method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Token ${auth.token}`},
                    body: JSON.stringify({ department_id: app.state.currentDept })
                });
                app.refreshData();
                btn.textContent = "Generate Schedule";
            },

            saveMyPrefs: async () => {
                await fetch(`${API_URL}/teachers/${auth.user.teacher_id}/`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json', 'Authorization': `Token ${auth.token}`},
                    body: JSON.stringify({ preferred_start_slot: document.getElementById('my-start').value, preferred_end_slot: document.getElementById('my-end').value })
                });
                alert("Preferences Saved!");
            }
        };

        // --- VIEWS ---
        const views = {
            home: () => `
                <section class="relative min-h-[90vh] flex items-center justify-center overflow-hidden pt-10">
                    <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                    <div class="absolute top-0 right-1/4 w-96 h-96 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
                    <div class="relative max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                        <div class="space-y-8 z-10 hero-content">
                            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass text-indigo-300 text-sm font-semibold border border-indigo-500/30"><span class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"></span> Intelligent Scheduler</div>
                            <h1 class="text-5xl md:text-7xl font-extrabold leading-tight">Stop Clashing. <br><span class="text-gradient">Start Teaching.</span></h1>
                            <p class="text-lg text-slate-300 max-w-lg leading-relaxed">The intelligent timetable generator that balances faculty workload, maximizes room utilization, and adapts to multidisciplinary curricula in seconds.</p>
                            <div class="flex gap-4">
                                <button onclick="router.navigate('dashboard')" class="px-8 py-4 bg-white text-slate-900 rounded-full font-bold text-lg hover:bg-indigo-50 transition-colors shadow-xl">Get Started</button>
                                <button class="px-8 py-4 glass rounded-full font-bold text-lg hover:bg-white/10 transition-colors flex items-center gap-2"><i class="fas fa-play"></i> Demo</button>
                            </div>
                        </div>
                        <div class="relative lg:h-[600px] w-full flex items-center justify-center hero-visual">
                            <div class="relative w-full max-w-md aspect-square">
                                <div class="absolute top-0 right-0 w-64 h-40 glass-card rounded-2xl p-4 transform rotate-6 z-10 floating-card"><div class="flex justify-between items-start mb-2"><div class="w-8 h-8 rounded bg-pink-500/20 text-pink-400 flex items-center justify-center"><i class="fas fa-flask"></i></div><span class="text-xs text-slate-400">07:30 AM</span></div><div class="h-2 w-1/2 bg-slate-700 rounded mb-2"></div><div class="h-2 w-3/4 bg-slate-700 rounded"></div></div>
                                <div class="absolute top-20 left-0 w-64 h-40 glass-card rounded-2xl p-4 transform -rotate-3 z-20 floating-card" style="animation-delay: 1s;"><div class="flex justify-between items-start mb-2"><div class="w-8 h-8 rounded bg-indigo-500/20 text-indigo-400 flex items-center justify-center"><i class="fas fa-laptop-code"></i></div><span class="text-xs text-slate-400">11:00 AM</span></div><div class="h-2 w-1/2 bg-slate-700 rounded mb-2"></div><div class="h-2 w-3/4 bg-slate-700 rounded"></div></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="py-24 bg-slate-900/50">
                    <div class="max-w-7xl mx-auto px-4 text-center mb-16"><h2 class="text-3xl font-bold mb-4">Why Chronos?</h2></div>
                    <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
                        ${['AI Optimization','Faculty Wellness','Multi-Shift'].map((t,i)=>`
                            <div class="glass-card p-8 rounded-2xl feature-card" data-index="${i}">
                                <div class="w-12 h-12 rounded bg-slate-800 flex items-center justify-center mb-4 text-indigo-400 text-xl"><i class="fas fa-check"></i></div>
                                <h3 class="text-xl font-bold mb-2">${t}</h3><p class="text-slate-400">Automated scheduling with constraint programming.</p>
                            </div>`).join('')}
                    </div>
                </section>`,

            dashboard: () => `
                <div class="w-full h-full flex flex-col lg:flex-row overflow-hidden">

                    <div class="w-full lg:w-1/3 min-w-[350px] bg-slate-900/50 border-r border-white/10 flex flex-col z-20 shadow-2xl relative">

                        <div class="p-6 border-b border-white/10 bg-slate-900/80 backdrop-blur-md sticky top-0 z-30">
                            <div id="admin-header" class="hidden">
                                <div class="flex items-center gap-2 mb-4 glass p-2 rounded-lg">
                                    <span class="text-xs font-bold text-slate-400 px-2">DEPT:</span>
                                    <select id="dept-select" onchange="app.refreshData()" class="bg-transparent text-sm font-bold text-indigo-300 outline-none flex-grow"><option>Loading...</option></select>
                                    <button onclick="app.refreshData()" class="text-slate-400 hover:text-white px-2"><i class="fas fa-sync"></i></button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.activeTab='subjects';app.renderDataManager()" class="flex-1 py-2 text-sm font-bold bg-indigo-600 text-white rounded shadow transition-all" id="btn-tab-sub">Subjects</button>
                                    <button onclick="app.activeTab='teachers';app.renderDataManager()" class="flex-1 py-2 text-sm font-bold bg-slate-800 hover:bg-slate-700 rounded transition-all" id="btn-tab-tea">Faculty</button>
                                </div>
                            </div>
                            <div id="faculty-header" class="hidden">
                                <h3 class="text-2xl font-bold text-pink-400 mb-1">My Preferences</h3>
                                <p class="text-xs text-slate-400">Set your availability constraints.</p>
                            </div>
                        </div>

                        <div id="data-manager" class="flex-grow overflow-y-auto p-4 space-y-3"></div>

                        <div id="faculty-prefs-panel" class="hidden p-6 border-t border-white/10 bg-slate-900/30">
                             <div class="grid grid-cols-2 gap-2 mb-4">
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase">Start Time</label><select id="my-start" class="custom-input py-1 text-sm"></select></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase">End Time</label><select id="my-end" class="custom-input py-1 text-sm"></select></div>
                            </div>
                            <button onclick="app.saveMyPrefs()" class="w-full bg-pink-600 hover:bg-pink-500 py-3 rounded text-xs font-bold shadow-lg transition-transform hover:scale-[1.02]">Save Availability</button>
                        </div>

                        <div id="admin-actions" class="hidden p-4 border-t border-white/10 bg-slate-900/80 backdrop-blur-md space-y-3">
                            <button onclick="app.openModal()" class="w-full py-3 border border-dashed border-indigo-500/50 text-indigo-300 text-sm font-bold hover:bg-indigo-500/10 rounded transition-colors">+ Add New Item</button>
                            <div class="flex gap-2">
                                <button onclick="app.saveChanges()" id="saveBtn" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded font-bold text-xs transition-colors">Save Changes</button>
                                <button onclick="app.runGeneration()" id="genBtn" class="flex-[2] py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded font-bold shadow-lg hover:shadow-indigo-600/40 transition-all text-xs hover:scale-[1.02]">Generate Schedule</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col bg-slate-900 relative z-10">
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-900/20 via-slate-900 to-slate-900 pointer-events-none"></div>
                        <div class="h-16 border-b border-white/10 flex items-center justify-between px-8 glass sticky top-0 z-30">
                            <h3 class="font-bold text-lg tracking-tight" id="table-title">Live Schedule</h3>
                            <div class="text-xs font-mono text-indigo-300 bg-indigo-900/30 px-3 py-1 rounded border border-indigo-500/30" id="status-text">VIEW ONLY</div>
                        </div>
                        <div class="flex-grow overflow-auto p-8">
                            <div class="bg-slate-800/40 rounded-2xl border border-white/5 overflow-hidden shadow-2xl backdrop-blur-sm">
                                <table class="w-full text-left border-collapse min-w-[800px]">
                                    <thead>
                                        <tr class="bg-slate-900/80">
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 w-28 tracking-wider">TIME</th>
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 tracking-wider">MONDAY</th>
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 tracking-wider">TUESDAY</th>
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 tracking-wider">WEDNESDAY</th>
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 tracking-wider">THURSDAY</th>
                                            <th class="p-4 text-xs font-bold text-slate-400 border-b border-white/10 tracking-wider">FRIDAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="timetable-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>`
        };

        // Start App
        window.addEventListener('DOMContentLoaded', () => {
            gsap.registerPlugin(ScrollTrigger);
            auth.updateNav();
            router.navigate('home');
        });
    </script>
</body>
</html>